# М7 платформа — маркетплейс внутри Telegram Mini App

## Слоган
М7 платформа — пространство для знакомств, товаров и услуг, жилья и работы в одном Mini App: «для всех и каждого».

## Концепция и миссия
- **Единый Mini App в Telegram**, где пользователь может:
  - найти людей для общения, отношений, дружбы или сотрудничества;
  - найти или предложить товары и услуги;
  - найти или сдать жильё;
  - найти работу или разместить вакансию / резюме.
- Минимум переключений между сервисами: все ключевые жизненные сценарии внутри одного опыта в Telegram.

## География и язык
- **Старт**: Санкт-Петербург.
- **Масштабирование**: сначала вся РФ, далее — глобальный рынок.
- **Язык интерфейса**: русский на старте; мультиязычность заложена как следующий этап.

## Целевая аудитория и возрастные ограничения
- **ЦА**: любые пользователи Telegram, которым нужны знакомства, товары/услуги, жильё или работа.
- **Возрастные правила**:
  - Если возраст **не подтверждён**: доступны знакомства (без 18+), товары/услуги; недоступны разделы «Жильё» и «Работа», 18+ контент заблокирован.
  - При **подтверждённом возрасте**: открываются разделы жилья и работы; может быть разблокирован 18+ контент в рамках правил и законодательства.

## Авторизация и роль Telegram-бота
### Ключевые принципы
- Авторизация не опирается на стандартный `initData` Telegram WebApp.
- Используется **username + одноразовый код**, доставленный через бота.

### Поток авторизации
1. Пользователь открывает Mini App.
2. Вводит свой Telegram **@username**.
3. Backend инициирует отправку кода через бота.
   - Чтобы бот смог доставить сообщение, пользователь должен сначала нажать **/start** и отправить любое сообщение боту (это фиксирует `chat_id`).
   - Если пользователь ещё не писал боту, код показывается в UI (delivery: `mock`) с подсказкой написать боту и запросить код заново.
4. Бот присылает одноразовый код в личные сообщения (delivery: `telegram`) после привязки `chat_id`.
5. Пользователь вводит код в Mini App.
6. Backend проверяет код и создаёт новый аккаунт или открывает существующий, после чего возвращает Mini App сессию/токен (детали будут конкретизированы позже).
- **@username обязателен** и является значимой частью профиля на платформе.

### Роль бота
- **Авторизация**: отправка кодов и подтверждение username.
- **Уведомления**:
  - новые матчи в знакомствах;
  - отклики на вакансии/резюме;
  - отклики на объявления (товары, услуги, жильё);
  - события модерации (одобрено/отклонено, жалобы, блокировки);
  - платежи и подписка (успешный платёж, окончание, напоминания).
- **Быстрые действия**:
  - кнопка «открыть Mini App»;
  - переход в чат с пользователем по матчу/объявлению.

### Настройка webhook бота для получения chat_id
- После деплоя Mini App нужно один раз зарегистрировать webhook:
  - взять `TELEGRAM_BOT_TOKEN` из окружения;
  - вызвать: `https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook?url=https://m7p.vercel.app/api/telegram/webhook`;
  - (опционально) добавить `X-Telegram-Bot-Api-Secret-Token` в настройке и проверять его в коде webhook.
- Пользователь должен открыть диалог с ботом, нажать **Start** и отправить любое сообщение; backend получит `chat_id` через webhook и привяжет его к `telegram_username`.
- Когда `telegram_chat_id` сохранён, коды авторизации доставляются в Telegram; если чат не привязан или доставка невозможна, код отображается в UI (delivery: `mock`).

## Режимы использования и монетизация
### Бесплатный режим
- Доступен всем авторизованным пользователям.
- Фокус — **знакомства**: анкета, поиск людей, свайпы как в Tinder, матчи.
- Ограничения: лимиты по анкетам/свайпам/просмотрам (точные параметры уточняются).
- Полный доступ к размещению в маркете/жилье/работе ограничен (просмотр обсуждается, размещение — по подписке).

### Режим по подписке
- Открывает размещение и активный поиск в разделах **товары/услуги, жильё, работа**.
- Расширенные функции: больше фильтров, повышенные лимиты, продвижение (поднятие, выделение), усиленные возможности в знакомствах (больше свайпов, расширенные фильтры).

### Разовые платные услуги
- Поднятие объявления.
- Закрепление в списке.
- Выделение цветом/рамкой.
- «Суперлайки» и аналогичные бусты в знакомствах.

## Основные разделы платформы
### Знакомства
- **Назначение**: быстрый поиск людей для отношений, дружбы, делового общения.
- **Сущности**: профиль/анкета (имя/ник, возраст, город, цели, интересы, фото и др.), матч (двусторонний интерес).
- **Интерфейс**: свайпы влево/вправо как в Tinder; фильтры по городу, возрасту, полу, целям, интересам и т.д.
- **Доступ**: открыт в бесплатном режиме; ограничения/лимиты могут сниматься подпиской.

### Маркет (товары и услуги)
- **Назначение**: размещение и поиск товаров и услуг (аналог маркетплейса / Авито).
- **Сущности**: объявление (категория, название, цена, описание, фото, локация и пр.).
- **Фильтры**: категории, цена, местоположение, состояние и т.д.
- **Доступ**: полноценное размещение — по подписке; просмотр может быть доступен всем (требует уточнения).

### Жильё
- **Назначение**: аренда жилья (позже возможно расширение на продажу).
- **Сущности**: объект жилья (тип, район/город, цена, фото, условия аренды и т.д.).
- **Фильтры**: тип, район/город, цена, длительность аренды, наличие мебели и т.д.
- **Доступ**: только после подтверждения возраста; размещение и расширенные фильтры — по подписке.

### Работа
- **Назначение**: поиск работы и специалистов (аналог hh / Профи / Авито Работа).
- **Сущности**: вакансия; резюме/профиль исполнителя.
- **Фильтры**: город, формат (офис/удалёнка), график, уровень дохода, опыт и т.д.
- **Доступ**: только после подтверждения возраста; публикация вакансий/резюме — по подписке.

## Модерация и роль ИИ
- **Гибридная модерация**: человек задаёт правила и принимает финальные решения; ИИ помогает автоматизировать первичный отбор.
- **ИИ-помощь**: фильтрация текстов (стоп-слова, запрещённый контент), анализ изображений (обнажёнка, насилие, запрещённые темы), антиспам, первичная проверка подозрительных анкет/объявлений.
- Пользователи могут отправлять жалобы; после жалобы возможна ручная проверка и блокировка/скрытие.

## Рекомендации и ранжирование
- Персонализация и сортировка планируются по:
  - геолокации (город, район);
  - возрасту, полу, целям, интересам — в знакомствах;
  - категориям и параметрам объявлений — в маркете;
  - типу и параметрам жилья (цена, локация) — в разделе жилья;
  - сфере работы, навыкам, опыту, зарплатным ожиданиям — в разделе работы.
- Активность пользователя (частота визитов) может учитываться как вторичный фактор в будущих версиях.

## Технологический стек (черновой план)
- **Mini App (frontend)**: Next.js (App Router, 14.x), TypeScript, работа внутри Telegram WebApp.
- **Backend (первый этап)**: API-роуты в Next.js (Node.js + TypeScript); при росте нагрузки возможно вынесение в отдельный сервис.
- **База данных**: Postgres через Supabase; схема на текущем этапе задаётся SQL-скриптами для Supabase, Prisma планируется как ORM/обёртка.
- **Авторизация и коммуникации**: Telegram Bot API (бот живёт в `apps/bot`).
- **Деплой**: фронт и API — Vercel (MVP); бот — serverless на Vercel или выделенный хостинг (обсуждается).

## Переменные окружения (черновой список)
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_BOT_USERNAME`
- `TELEGRAM_WEBHOOK_SECRET` (при использовании вебхуков)
- `NEXT_PUBLIC_APP_ENV`
- `NEXT_PUBLIC_API_BASE_URL`
- `DATABASE_URL` (Postgres / Supabase)
- `NEXT_PUBLIC_TELEGRAM_BOT_NAME` (при необходимости на фронте)
- Опционально для прямой работы фронта с Supabase: `SUPABASE_URL`, `SUPABASE_ANON_KEY`.

## Архитектурный поток (концептуально)
1. Пользователь в Telegram открывает Mini App.
2. Вводит свой **@username**.
3. Mini App обращается к backend’у → backend инициирует отправку кода через бота.
4. Бот отправляет код в личные сообщения пользователю.
5. Пользователь вводит код в Mini App.
6. Backend проверяет код, создаёт/читает пользователя в Postgres и отдаёт Mini App сессию/токен.
7. Далее пользователь:
   - создаёт анкету знакомств;
   - при подписке размещает объявления (товары, услуги, жильё, работа);
   - ищет по фильтрам;
   - получает уведомления от бота (матчи, отклики, модерация, платежи).

## Схема данных: знакомства (Supabase/Postgres)
- SQL-скрипт: `docs/db/004_dating_schema.sql`.
- Основные объекты:
  - `dating_profiles` — анкета пользователя с целями знакомств (`purposes`), текстовыми полями («что ищу», «что предлагаю», комментарий), ссылками на другие разделы (market/housing/jobs), массивом фото `photo_urls` и признаком `has_photo`.
  - `dating_swipes` — решения пользователя по чужим анкетам (`decision: like|dislike`), уникальность по паре `(from_user_id, to_profile_id)`.
  - `dating_matches` — взаимные лайки. Пара пользователей хранится в отсортированном виде, уникальность обеспечивается индексом `uniq_dating_matches_pair`.
  - Enum `dating_purpose` фиксирует цели: romantic, friends, co_rent, rent_tenant, rent_landlord, market_seller, market_buyer, job_employer, job_seeker, job_buddy.
- Триггер `set_updated_at` переиспользуется для `dating_profiles.updated_at`. RLS пока не включён.

## Dating purposes (цели знакомств)
- Используются во всех сценариях знакомств: анкета (`dating_profiles.purposes`), лента, фильтры и мэтчи.
- Без выбранной цели анкета не считается полноценной и не сохранится через API.
- Перечень значений enum `dating_purpose` и их смысл:
  - `romantic` — романтика / общение: поиск свиданий, отношений или лёгкого общения.
  - `friends` — дружба: поиск единомышленников для общения и совместных активностей.
  - `co_rent` — снимать жильё вместе: поиск соседа/пары для совместной аренды.
  - `rent_tenant` — ищу жильё как арендатор: поиск квартиры или комнаты в аренду.
  - `rent_landlord` — сдаю жильё: предложение квартиры или комнаты в аренду.
  - `market_seller` — продаю / оказываю услуги: предложение товаров или услуг внутри М7.
  - `market_buyer` — покупаю / ищу услуги: поиск товаров или услуг у участников.
  - `job_employer` — ищу сотрудников: набор специалистов в команду или на проект.
  - `job_seeker` — ищу работу: открытость к предложениям о работе или проектам.
  - `job_buddy` — ищу напарника: поиск партнёра для стартапа, pet-проекта или коллаборации.
  - В будущем от выбранных целей будет зависеть фильтрация и рекомендации в ленте.

## API Mini App: знакомства
Реализованы в `apps/miniapp/app/api/dating/*` (работают при наличии сессионной куки `m7_session`).
- `GET /api/dating/profile` — вернуть анкету текущего пользователя или `null`.
- `PUT /api/dating/profile` — создать/обновить анкету. Валидация: непустые `nickname`, `looking_for`, `offering`, минимум один `purposes`.
- `GET /api/dating/feed` — лента активных анкет без уже просмотренных/свайпнутых. Параметры: `limit` (<=50), `purposes` (фильтр по пересечению целей).
- `POST /api/dating/swipe` — лайк/дизлайк анкеты. При обоюдном лайке создаётся запись в `dating_matches`.
- `GET /api/dating/matches` — список матчей текущего пользователя с данными другого профиля и ссылкой на Telegram.

## Роли компонентов
- **Mini App**: UI/UX внутри Telegram WebApp; сбор данных пользователя, показ лент и карточек, вызовы backend API.
- **Бот**: отправка кодов авторизации, уведомления, быстрые действия для возврата в Mini App или связи с пользователем.
- **Backend**: проверка кодов, управление подписками, модерация, обработка объявлений, API для Mini App и бота.
- **База данных (Postgres/Supabase)**: хранение пользователей, анкет, объявлений, подписок, логов модерации.

## Структура репозитория
- `apps/miniapp/` — будущий Telegram Mini App (Next.js + TypeScript) с разделами: знакомства, маркет, жильё, работа.
- `apps/bot/` — будущий Telegram-бот для авторизации, уведомлений и быстрых действий.
- `packages/shared/` — будущие общие типы, модели домена, константы и утилиты.
- `docs/` — архитектурные и продуктовые документы (черновики, брифы, схемы).

## Правила для задач и документации
- Любая выполненная задача (любой исполнителем) **обязана**:
  - обновлять корневой `README.md` и/или соответствующий документ в `docs/`, чтобы архитектура и логика оставались актуальными;
  - добавлять подпункт в раздел `## История изменений / Tasks log` со структурой: краткое имя задачи, дата, список затронутых файлов/папок, краткое описание изменённой архитектуры/логики (поток данных: пользователь → интерфейс → backend → база → обратно).
- Цель: чтобы по одному `README.md` и документам в `docs/` любой новый разработчик или ИИ-архитектор быстро понимал, что делает М7 платформа и где искать код конкретных частей.

## История изменений / Tasks log

### Инициализация репозитория и базовой структуры (дата: 2025-12-05)
- Затронутые файлы и папки:
  - `README.md`
  - `apps/miniapp/README.md`
  - `apps/bot/README.md`
  - `packages/shared/README.md`
  - `docs/README.md`
  - создана базовая структура директорий `apps/`, `packages/`, `docs/`.
- Краткое описание:
  - Создан монорепозиторий `m7-platform` под проект «М7 платформа» — маркетплейс внутри Telegram Mini App.
  - Описана общая концепция продукта (знакомства, товары/услуги, жильё, работа), география, ЦА и возрастные ограничения.
  - Зафиксирована схема авторизации через Telegram-бота (username + код) и роль бота (авторизация, уведомления, быстрые действия).
  - Обозначен черновой технологический стек (Next.js, Node.js, Postgres/Supabase, Prisma, Telegram Bot API) и список переменных окружения.
  - Описан архитектурный поток: от открытия Mini App и ввода username → отправки кода ботом → проверки кода backend’ом → работы с разделами и уведомлениями.

### Инициализация Mini App и базовой SQL-схемы (дата: 2025-12-06)
- Затронутые файлы и папки:
  - `apps/miniapp/*`
  - `docs/db/001_init_users_and_auth_codes.sql`
  - `README.md`
- Краткое описание:
  - Создано базовое приложение Mini App на Next.js 14 (App Router, TypeScript) с разделами-заглушками «Знакомства», «Маркет», «Жильё», «Работа».
  - Добавлен SQL-скрипт для Supabase, создающий таблицы `users` и `auth_codes` под авторизацию через Telegram @username + одноразовый код.
  - Уточнён текущий подход к схеме БД: на этом этапе структура задаётся через SQL-скрипты для Supabase (Prisma остаётся в стеке как потенциальный ORM на следующих этапах).

### Авторизация через Telegram @username + одноразовый код (дата: 2025-12-07)
- Затронутые файлы и папки:
  - `apps/miniapp/app/api/auth/request-code/route.ts`
  - `apps/miniapp/app/api/auth/verify-code/route.ts`
  - `apps/miniapp/lib/currentUser.ts`
  - `apps/miniapp/lib/auth.ts`
  - `apps/miniapp/lib/supabaseConfig.ts`
  - `apps/miniapp/components/AuthForm.tsx`
  - `apps/miniapp/app/(auth-related files)`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Реализован backend-поток авторизации: запрос кода по @username, сохранение кодов в таблице `auth_codes`, проверка кода, создание/чтение пользователя в таблице `users`, выдача JWT-сессии в HttpOnly-cookie.
  - Добавлен frontend-UI авторизации в Mini App (двухшаговая форма ввода username и кода), ограничивающий доступ к разделам платформы без входа.
  - Добавлена утилита определения текущего пользователя на серверной стороне для использования в layout и дальнейших разделах.

### Привязка Telegram chat_id и отправка кодов авторизации в бот (дата: 2025-12-08)
- Затронутые файлы и папки:
  - `docs/db/003_add_telegram_chat_id.sql`
  - `apps/miniapp/app/api/telegram/webhook/route.ts`
  - `apps/miniapp/app/api/auth/request-code/route.ts`
  - `apps/miniapp/components/AuthForm.tsx`
  - `README.md`
- Краткое описание:
  - Добавлено поле `telegram_chat_id` в таблицу `users` и индекс для быстрого поиска по chat_id.
  - Реализован webhook `/api/telegram/webhook`, сохраняющий `chat_id` из сообщений боту и связывающий его с `telegram_username`.
  - Отправка одноразовых кодов теперь идёт в личный чат по `telegram_chat_id`; если чат не привязан или отправка невозможна, код показывается в UI (delivery: `mock`).
  - Обновлена документация и тексты в UI, подсказывающие пользователю написать боту /start перед получением кода.

### MVP раздела «Знакомства»: схема, API, базовый UI (дата: 2025-12-09)
- Затронутые файлы и папки:
  - `docs/db/004_dating_schema.sql`
  - `apps/miniapp/app/api/dating/*`
  - `apps/miniapp/app/dating/page.tsx`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Добавлены таблицы `dating_profiles`, `dating_swipes`, `dating_matches` и enum `dating_purpose` для целей знакомств; настроены индексы и триггер обновления `updated_at`.
  - Реализованы сервисные маршруты `/api/dating/profile`, `/api/dating/feed`, `/api/dating/swipe`, `/api/dating/matches` с использованием `currentUser` и сервисного клиента Supabase.
  - Раздел «Знакомства» в Mini App переведён в рабочий режим: онбординг и редактирование анкеты, лента свайпов с записью решений и алертом о мэтче, блок «Мои мэтчи» с переходом в Telegram, компактный каталог последних анкет.

### Финализация целей знакомств и UI анкеты (дата: 2025-12-09)
- Затронутые файлы и папки:
  - `docs/db/005_update_dating_purpose.sql`
  - `apps/miniapp/app/api/dating/*`
  - `apps/miniapp/app/dating/page.tsx`
  - `apps/miniapp/lib/datingPurposes.ts`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Расширен enum `dating_purpose` до финального набора (добавлен `friends`) с безопасной миграцией.
  - Добавлен единый список целей знакомств для фронтенда и строгой серверной валидации.
  - Обновлена форма анкеты: показ 10 целей с описаниями, обязательный выбор целей и обработка ошибки `PURPOSES_REQUIRED`.
  - Документация дополнена разделом про цели знакомств.

