# М7 платформа — маркетплейс внутри Telegram Mini App

## Слоган
М7 платформа — пространство для знакомств, товаров и услуг, жилья и работы в одном Mini App: «для всех и каждого».

## Концепция и миссия
- **Единый Mini App в Telegram**, где пользователь может:
  - найти людей для общения, отношений, дружбы или сотрудничества;
  - найти или предложить товары и услуги;
  - найти или сдать жильё;
  - найти работу или разместить вакансию / резюме.
- Минимум переключений между сервисами: все ключевые жизненные сценарии внутри одного опыта в Telegram.

## Главный экран-хаб (BotFather-style)
- При запуске Mini App открывается единый экран-хаб с карточкой «M7 Платформа» и списком разделов.
- Каждый пункт ведёт на отдельный экран или заглушку:
  - **Профиль** — Telegram-профиль, анкета, настройки (планируется полноценный экран).
  - **Правила и инструкция** — как работает платформа и правила сервиса (заглушка до готовности контента).
  - **Знакомства** — анкета, лента, матчи, приватность.
  - **Маркет** — товары и услуги, объявления, поиск по фильтрам.
  - **Жильё** — аренда жилья, соседи, объявления по городам.
  - **Работа** — вакансии и резюме, поиск работы и сотрудников.
  - **Карты** — объявления на карте (в разработке).
  - **Модерация** — панели по жалобам и объявлениям (доступ для модераторов).

## География и язык
- **Старт**: Санкт-Петербург.
- **Масштабирование**: сначала вся РФ, далее — глобальный рынок.
- **Язык интерфейса**: русский на старте; мультиязычность заложена как следующий этап.

## Целевая аудитория и возрастные ограничения
- **ЦА**: любые пользователи Telegram, которым нужны знакомства, товары/услуги, жильё или работа.
- **Возрастные правила**:
  - Если возраст **не подтверждён**: доступны знакомства (без 18+), товары/услуги; недоступны разделы «Жильё» и «Работа», 18+ контент заблокирован.
  - При **подтверждённом возрасте**: открываются разделы жилья и работы; может быть разблокирован 18+ контент в рамках правил и законодательства.

## Авторизация и роль Telegram-бота
### Ключевые принципы
- Авторизация не опирается на стандартный `initData` Telegram WebApp.
- Используется **username + одноразовый код**, доставленный через бота.

### Поток авторизации
1. Пользователь открывает Mini App.
2. Вводит свой Telegram **@username**.
3. Backend инициирует отправку кода через бота.
   - Чтобы бот смог доставить сообщение, пользователь должен сначала нажать **/start** и отправить любое сообщение боту (это фиксирует `chat_id`).
   - Если пользователь ещё не писал боту, код показывается в UI (delivery: `mock`) с подсказкой написать боту и запросить код заново.
4. Бот присылает одноразовый код в личные сообщения (delivery: `telegram`) после привязки `chat_id`.
5. Пользователь вводит код в Mini App.
6. Backend проверяет код и создаёт новый аккаунт или открывает существующий, после чего возвращает Mini App сессию/токен (детали будут конкретизированы позже).
- **@username обязателен** и является значимой частью профиля на платформе.

### Роль бота
- **Авторизация**: отправка кодов и подтверждение username.
- **Уведомления**:
  - новые матчи в знакомствах;
  - отклики на вакансии/резюме;
  - отклики на объявления (товары, услуги, жильё);
  - события модерации (одобрено/отклонено, жалобы, блокировки);
  - платежи и подписка (успешный платёж, окончание, напоминания).
- **Быстрые действия**:
  - кнопка «открыть Mini App»;
  - переход в чат с пользователем по матчу/объявлению.

### Настройка webhook бота для получения chat_id
- После деплоя Mini App нужно один раз зарегистрировать webhook:
  - взять `TELEGRAM_BOT_TOKEN` из окружения;
  - вызвать: `https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook?url=https://m7p.vercel.app/api/telegram/webhook`;
  - (опционально) добавить `X-Telegram-Bot-Api-Secret-Token` в настройке и проверять его в коде webhook.
- Пользователь должен открыть диалог с ботом, нажать **Start** и отправить любое сообщение; backend получит `chat_id` через webhook и привяжет его к `telegram_username`.
- Когда `telegram_chat_id` сохранён, коды авторизации доставляются в Telegram; если чат не привязан или доставка невозможна, код отображается в UI (delivery: `mock`).

## Режимы использования и монетизация
### Бесплатный режим
- Доступен всем авторизованным пользователям.
- Фокус — **знакомства**: анкета, поиск людей, свайпы как в Tinder, матчи.
- Ограничения: лимиты по анкетам/свайпам/просмотрам (точные параметры уточняются).
- Полный доступ к размещению в маркете/жилье/работе ограничен (просмотр обсуждается, размещение — по подписке).

### Режим по подписке
- Открывает размещение и активный поиск в разделах **товары/услуги, жильё, работа**.
- Расширенные функции: больше фильтров, повышенные лимиты, продвижение (поднятие, выделение), усиленные возможности в знакомствах (больше свайпов, расширенные фильтры).

### Разовые платные услуги
- Поднятие объявления.
- Закрепление в списке.
- Выделение цветом/рамкой.
- «Суперлайки» и аналогичные бусты в знакомствах.

## Основные разделы платформы
### Знакомства
- **Назначение**: быстрый поиск людей для отношений, дружбы, делового общения.
- **Сущности**: профиль/анкета (имя/ник, возраст, город, цели, интересы, фото и др.), матч (двусторонний интерес).
- **Интерфейс**: свайпы влево/вправо как в Tinder; фильтры по городу, возрасту, полу, целям, интересам и т.д.
- **Доступ**: открыт в бесплатном режиме; ограничения/лимиты могут сниматься подпиской.
- **Модерация**: таблица `dating_reports` хранит жалобы на пользователей (причина + комментарий), API `/api/dating/report` принимает жалобы от авторизованных пользователей; при достижении 3 жалоб аккаунт помечается `users.status = banned`, профиль исключается из ленты/новых мэтчей, но остаётся в существующих мэтчах с пометкой «Профиль временно недоступен». Поля и индексы для модерации добавляются миграцией `docs/db/010_dating_reports_moderation.sql`.

### Маркет (товары и услуги)
- **Назначение**: размещение и поиск товаров и услуг (аналог маркетплейса / Авито).
- **Сущности**: объявления в `market_listings` — заголовок, описание, категория, тип (`product`/`service`), цена с валютой, город/онлайн, статус, ссылки на пользователя.
- **Фильтры**: категории, цена, местоположение, состояние и т.д.
- **Доступ**: полноценное размещение — по подписке; просмотр может быть доступен всем (требует уточнения).

### Жильё
- **Назначение**: аренда жилья (позже возможно расширение на продажу).
- **Сущности**: объявления в `housing_listings` — заголовок, описание, тип предложения (`rent_out`/`rent_in`), тип объекта, город/район, цена в месяц с валютой, параметры доступности и минимального срока, статус, владелец.
- **Фильтры**: тип, район/город, цена, длительность аренды, наличие мебели и т.д.
- **Доступ**: только после подтверждения возраста; размещение и расширенные фильтры — по подписке.

### Работа
- **Назначение**: поиск работы и специалистов (аналог hh / Профи / Авито Работа).
- **Сущности**: объявления в `job_listings` — тип записи (`vacancy`/`resume`), заголовок, описание, город, формат занятости, вилка дохода с валютой, уровень опыта, статус, владелец.
- **Фильтры**: город, формат (офис/удалёнка), график, уровень дохода, опыт и т.д.
- **Доступ**: только после подтверждения возраста; публикация вакансий/резюме — по подписке.

## Модерация и роль ИИ
- **Гибридная модерация**: человек задаёт правила и принимает финальные решения; ИИ помогает автоматизировать первичный отбор.
- **ИИ-помощь**: фильтрация текстов (стоп-слова, запрещённый контент), анализ изображений (обнажёнка, насилие, запрещённые темы), антиспам, первичная проверка подозрительных анкет/объявлений.
- Пользователи могут отправлять жалобы; после жалобы возможна ручная проверка и блокировка/скрытие.

### Moderation / Dating
- Доступ: только пользователи из `MODERATOR_USERNAMES` (кома-разделённый список Telegram-username без `@`, например `aiurm7`).
- Панель: в Mini App по пути `/moderation/dating` (серверный чек — `notFound()` для немодераторов).
- Возможности панели: список жалоб с фильтрами по статусу, типу нарушения и пользователю; карточки жалоб показывают цель, автора жалобы, текст и счётчик всех жалоб на пользователя; действия «пометить обработанной», «забанить», «снять бан» вызывают `/api/moderation/dating`.
- API `/api/moderation/dating` (только модераторы):
  - `GET` — возврат жалоб (до 100) с джойном авторов/целей, флагом бана и счётчиком жалоб, плюс статистика (активные/забаненные анкеты, новые жалобы, жалобы за 24ч/7дн).
  - `POST resolveReport|banUser|unbanUser` — обновляет статус жалобы и `users.status`, логирует `resolved_at`, `resolved_by_user_id`, `moderator_note` в таблице `dating_reports` (см. миграцию `docs/db/010_dating_reports_moderation.sql`).
- Статусы жалоб: `new` (новая), `resolved` (обработана). Исторический `pending` приводится к `new` миграцией `docs/db/010_dating_reports_moderation.sql`. Автобан остаётся по 3 жалобам (`users.status = banned`); ручной бан/анбан меняет `users.status` без удаления жалоб, поэтому повторные жалобы могут снова включить автобан.

### Moderation / Listings
- Таблица `listing_reports` (миграция `docs/db/011_listing_reports.sql`) хранит жалобы на объявления в разделах Маркет/Жильё/Работа: секция, `listing_id`, автор жалобы, владелец объявления, причина, комментарий, статус `new|resolved`, отметки модератора.
- Пользователь может отправить жалобу через `POST /api/listings/report` (требуется сессия). После трёх новых жалоб объявление автоматически архивируется (`status = archived`) до решения модератора.
- Панель модератора `/moderation/listings` (доступ для `MODERATOR_USERNAMES`): фильтры по статусу и разделу, карточки с данными объявления, авторами, счётчиком жалоб и статусом владельца. Действия: пометить жалобу обработанной, скрыть/вернуть объявление, забанить/разбанить владельца.
- API `/api/moderation/listings` (только модераторы):
  - `GET` — жалобы с владельцами/авторами и сводкой (новые жалобы по секциям, активные/архивные объявления с жалобами).
  - `POST resolveReport|archiveListing|unarchiveListing|banUser|unbanUser` — отмечает жалобу, меняет статус объявления или владельца, сохраняет `resolved_at`/`resolved_by_user_id` и `moderator_note` при необходимости.

## Рекомендации и ранжирование
- Персонализация и сортировка планируются по:
  - геолокации (город, район);
  - возрасту, полу, целям, интересам — в знакомствах;
  - категориям и параметрам объявлений — в маркете;
  - типу и параметрам жилья (цена, локация) — в разделе жилья;
  - сфере работы, навыкам, опыту, зарплатным ожиданиям — в разделе работы.
- Активность пользователя (частота визитов) может учитываться как вторичный фактор в будущих версиях.

## Технологический стек (черновой план)
- **Mini App (frontend)**: Next.js (App Router, 14.x), TypeScript, работа внутри Telegram WebApp.
- **Backend (первый этап)**: API-роуты в Next.js (Node.js + TypeScript); при росте нагрузки возможно вынесение в отдельный сервис.
- **База данных**: Postgres через Supabase; схема на текущем этапе задаётся SQL-скриптами для Supabase, Prisma планируется как ORM/обёртка.
- **Авторизация и коммуникации**: Telegram Bot API (бот живёт в `apps/bot`).
- **Деплой**: фронт и API — Vercel (MVP); бот — serverless на Vercel или выделенный хостинг (обсуждается).

## Переменные окружения (черновой список)
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_BOT_USERNAME`
- `TELEGRAM_WEBHOOK_SECRET` (при использовании вебхуков)
- `NEXT_PUBLIC_APP_ENV`
- `NEXT_PUBLIC_API_BASE_URL`
- `DATABASE_URL` (Postgres / Supabase)
- `NEXT_PUBLIC_TELEGRAM_BOT_NAME` (при необходимости на фронте)
- Опционально для прямой работы фронта с Supabase: `SUPABASE_URL`, `SUPABASE_ANON_KEY`.

## Архитектурный поток (концептуально)
1. Пользователь в Telegram открывает Mini App.
2. Вводит свой **@username**.
3. Mini App обращается к backend’у → backend инициирует отправку кода через бота.
4. Бот отправляет код в личные сообщения пользователю.
5. Пользователь вводит код в Mini App.
6. Backend проверяет код, создаёт/читает пользователя в Postgres и отдаёт Mini App сессию/токен.
7. Далее пользователь:
   - создаёт анкету знакомств;
   - при подписке размещает объявления (товары, услуги, жильё, работа);
   - ищет по фильтрам;
   - получает уведомления от бота (матчи, отклики, модерация, платежи).

## Схема данных: знакомства (Supabase/Postgres)
- SQL-скрипт: `docs/db/004_dating_schema.sql`.
- Основные объекты:
- `dating_profiles` — анкета пользователя с целями знакомств (`purposes`), текстовыми полями («что ищу», «что предлагаю», комментарий), ссылками на другие разделы (market/housing/jobs), массивом фото `photo_urls` и признаком `has_photo`. Поддерживает флаги видимости (`show_listings`, `is_active`) и дату актуальности `last_activated_at` (анкету нужно обновлять раз в 90 дней). Добавлены предпочтения для подбора (пол партнёров `preferred_genders`, возрастной диапазон `preferred_age_min`/`preferred_age_max`, режим города `preferred_city_mode`) и детализация показа объявлений по разделам (`show_market_listings_in_profile`, `show_housing_listings_in_profile`, `show_job_listings_in_profile`).
  - `dating_swipes` — решения пользователя по чужим анкетам (`decision: like|dislike`), уникальность по паре `(from_user_id, to_profile_id)`.
  - `dating_matches` — взаимные лайки. Пара пользователей хранится в отсортированном виде, уникальность обеспечивается индексом `uniq_dating_matches_pair`.
  - Enum `dating_purpose` фиксирует цели: romantic, friends, co_rent, rent_tenant, rent_landlord, market_seller, market_buyer, job_employer, job_seeker, job_buddy.
- Триггер `set_updated_at` переиспользуется для `dating_profiles.updated_at`. RLS пока не включён.

## Dating purposes (цели знакомств)
- Используются во всех сценариях знакомств: анкета (`dating_profiles.purposes`), лента, фильтры и мэтчи.
- Без выбранной цели анкета не считается полноценной и не сохранится через API.
- Перечень значений enum `dating_purpose` и их смысл:
  - `romantic` — романтика / общение: поиск свиданий, отношений или лёгкого общения.
  - `friends` — дружба: поиск единомышленников для общения и совместных активностей.
  - `co_rent` — снимать жильё вместе: поиск соседа/пары для совместной аренды.
  - `rent_tenant` — ищу жильё как арендатор: поиск квартиры или комнаты в аренду.
  - `rent_landlord` — сдаю жильё: предложение квартиры или комнаты в аренду.
  - `market_seller` — продаю / оказываю услуги: предложение товаров или услуг внутри М7.
  - `market_buyer` — покупаю / ищу услуги: поиск товаров или услуг у участников.
  - `job_employer` — ищу сотрудников: набор специалистов в команду или на проект.
  - `job_seeker` — ищу работу: открытость к предложениям о работе или проектам.
  - `job_buddy` — ищу напарника: поиск партнёра для стартапа, pet-проекта или коллаборации.
  - В будущем от выбранных целей будет зависеть фильтрация и рекомендации в ленте.

## Схема данных: Маркет / Жильё / Работа
- SQL-скрипт: `docs/db/006_market_housing_jobs.sql` — его нужно выполнить в Supabase при разворачивании БД (создаёт таблицы, индексы и триггеры `set_updated_at`).
- Таблицы объявлений:
  - `market_listings` — товары и услуги (title, description, category, type, price/currency, city, is_online, status, ссылки на автора).
  - `housing_listings` — объявления по аренде (offer_type, property_type, city/district, price_per_month, доступность, статус и др.).
  - `job_listings` — вакансии и резюме (role_type, title, city, employment_format, salary_from/to, experience_level, status).
- Все таблицы содержат `status` с базовыми значениями draft/active/archived и обновляются по `updated_at` через триггер.
- Таблица `listing_contact_purchases` (`docs/db/009_listing_contact_purchases.sql`) фиксирует покупку контакта владельца объявления (`section`, `listing_id`, `buyer_user_id`) с фиксированной ценой 50 ₽ (5000 копеек). Миграцию нужно выполнить в Supabase вместе с базовыми таблицами объявлений.

## API Mini App: профиль и знакомства
Реализованы в `apps/miniapp/app/api/*` (работают при наличии сессионной куки `m7_session`).
- `GET /api/profile` — базовый профиль пользователя (`gender`, `birthDate`, `city`, `about`, `isAdultProfile`) и статистика по анкетам/объявлениям.
- `PUT /api/profile` — частичное обновление базового профиля с валидацией возраста (14–120 лет, флаг 18+ только после 18 лет).
- `GET /api/dating/profile` — вернуть анкету текущего пользователя или `null` (собирает данные анкеты и базового профиля).
- `PUT /api/dating/profile` — создать/обновить анкету. Валидация: непустые `nickname`, `looking_for`, `offer`, минимум один `purposes`; при включённой анкете (`is_active = true`) требуется заполненный базовый профиль. Добавлены предпочтения `preferred_genders`, возрастной диапазон и режим города, а также флаги показа объявлений по разделам.
- `GET /api/dating/feed` — лента активных анкет без уже просмотренных/свайпнутых. Параметры: `limit` (<=50), `purposes` (фильтр по пересечению целей, можно перечислять через запятую). Выбирает только анкеты с `is_active=true`, актуальные за 90 дней, подходящие по полу, возрасту, городу (для `same_city`) и возрастным ограничениям 18+/до 18.
- `POST /api/dating/swipe` — лайк/дизлайк анкеты. При обоюдном лайке создаётся запись в `dating_matches`.
- `GET /api/dating/matches` — список матчей текущего пользователя с данными другого профиля и ссылкой на Telegram.

## Роли компонентов
- **Mini App**: UI/UX внутри Telegram WebApp; сбор данных пользователя, показ лент и карточек, вызовы backend API.
- **Бот**: отправка кодов авторизации, уведомления, быстрые действия для возврата в Mini App или связи с пользователем.
- **Backend**: проверка кодов, управление подписками, модерация, обработка объявлений, API для Mini App и бота.
- **База данных (Postgres/Supabase)**: хранение пользователей, анкет, объявлений, подписок, логов модерации.

## Структура репозитория
- `apps/miniapp/` — будущий Telegram Mini App (Next.js + TypeScript) с разделами: знакомства, маркет, жильё, работа.
- `apps/bot/` — будущий Telegram-бот для авторизации, уведомлений и быстрых действий.
- `packages/shared/` — будущие общие типы, модели домена, константы и утилиты.
- `docs/` — архитектурные и продуктовые документы (черновики, брифы, схемы).

## Правила для задач и документации
- Любая выполненная задача (любой исполнителем) **обязана**:
  - обновлять корневой `README.md` и/или соответствующий документ в `docs/`, чтобы архитектура и логика оставались актуальными;
  - добавлять подпункт в раздел `## История изменений / Tasks log` со структурой: краткое имя задачи, дата, список затронутых файлов/папок, краткое описание изменённой архитектуры/логики (поток данных: пользователь → интерфейс → backend → база → обратно).
- Цель: чтобы по одному `README.md` и документам в `docs/` любой новый разработчик или ИИ-архитектор быстро понимал, что делает М7 платформа и где искать код конкретных частей.

## История изменений / Tasks log

### Инициализация репозитория и базовой структуры (дата: 2025-12-05)

### Шаг 2: базовые таблицы для Маркета, Жилья и Работы (дата: 2025-12-07)
- **Файлы**: `docs/db/006_market_housing_jobs.sql`, `README.md`
- **Изменения**: добавлены таблицы объявлений `market_listings`, `housing_listings`, `job_listings` с базовыми полями, индексами и триггерами `updated_at`; README дополнен описанием сущностей в разделах Маркет/Жильё/Работа.
- Затронутые файлы и папки:
  - `README.md`
  - `apps/miniapp/README.md`
  - `apps/bot/README.md`
  - `packages/shared/README.md`
  - `docs/README.md`
  - создана базовая структура директорий `apps/`, `packages/`, `docs/`.
- Краткое описание:

### Расширение анкет знакомств и настроек видимости (дата: 2025-12-08)
- **Файлы**: `docs/db/007_dating_profile_extension.sql`, `apps/miniapp/app/api/dating/*`, `apps/miniapp/app/dating/page.tsx`, `README.md`
- **Изменения**: анкеты знакомств поддерживают несколько целей, поля «кого ищу/что предлагаю», ручное отключение (`is_active`) и скрытие объявлений (`show_listings`), срок актуальности 90 дней с отметкой `last_activated_at`. Backend-фиды фильтруют неактивные/просроченные анкеты, UI добавляет новые переключатели, предупреждение об устаревшей анкете и обновление через PUT профиля.
- **Поток данных**: пользователь редактирует анкету в `apps/miniapp/app/dating/page.tsx` → запрос `PUT /api/dating/profile` обновляет таблицу `dating_profiles` (флаги, массив целей, `last_activated_at`) → лента `/api/dating/feed` выдаёт только актуальные активные анкеты, `/api/dating/matches` фильтрует неактивные → UI скрывает объявления, если задано, и показывает напоминание об обновлении анкеты.
  - Создан монорепозиторий `m7-platform` под проект «М7 платформа» — маркетплейс внутри Telegram Mini App.
  - Описана общая концепция продукта (знакомства, товары/услуги, жильё, работа), география, ЦА и возрастные ограничения.
  - Зафиксирована схема авторизации через Telegram-бота (username + код) и роль бота (авторизация, уведомления, быстрые действия).
  - Обозначен черновой технологический стек (Next.js, Node.js, Postgres/Supabase, Prisma, Telegram Bot API) и список переменных окружения.

### Профиль и предпочтения знакомств (дата: 2025-12-10)
- **Файлы**: `docs/db/014_user_profile_core.sql`, `docs/db/015_dating_preferences_and_listings_flags.sql`, `apps/miniapp/app/api/profile/route.ts`, `apps/miniapp/app/api/dating/profile/route.ts`, `apps/miniapp/app/api/dating/feed/route.ts`, `apps/miniapp/app/profile/page.tsx`, `apps/miniapp/app/dating/page.tsx`, `README.md`.
- **Изменения**: добавлена единая модель профиля пользователя (`gender`, `birth_date`, `city`, `about`, `is_adult_profile`) с API `/api/profile`; анкета знакомств расширена предпочтениями по полу, возрасту и гео, флагами показа объявлений по разделам; лента `/api/dating/feed` фильтрует анкеты по полу, возрасту, городу и логике 18+/minor; Mini App получила страницу `/profile` с вкладками «Основное», «Знакомства», «Мои объявления» и кнопки перехода из раздела знакомств.
- **Поток данных**: пользователь заполняет базовый профиль на `/profile` → `PUT /api/profile` обновляет таблицу `users` с валидацией возраста → на вкладке «Знакомства» отправляется `PUT /api/dating/profile`, сохраняющий предпочтения в `dating_profiles` и актуализирующий `last_activated_at` → лента `/api/dating/feed` использует пол, возраст, город и предпочтения для фильтрации кандидатов; показы объявлений в анкете зависят от флагов `show_*_listings_in_profile`.
  - Описан архитектурный поток: от открытия Mini App и ввода username → отправки кода ботом → проверки кода backend’ом → работы с разделами и уведомлениями.

### Инициализация Mini App и базовой SQL-схемы (дата: 2025-12-06)
- Затронутые файлы и папки:
  - `apps/miniapp/*`
  - `docs/db/001_init_users_and_auth_codes.sql`
  - `README.md`
- Краткое описание:
  - Создано базовое приложение Mini App на Next.js 14 (App Router, TypeScript) с разделами-заглушками «Знакомства», «Маркет», «Жильё», «Работа».
  - Добавлен SQL-скрипт для Supabase, создающий таблицы `users` и `auth_codes` под авторизацию через Telegram @username + одноразовый код.
  - Уточнён текущий подход к схеме БД: на этом этапе структура задаётся через SQL-скрипты для Supabase (Prisma остаётся в стеке как потенциальный ORM на следующих этапах).

### Авторизация через Telegram @username + одноразовый код (дата: 2025-12-07)
- Затронутые файлы и папки:
  - `apps/miniapp/app/api/auth/request-code/route.ts`
  - `apps/miniapp/app/api/auth/verify-code/route.ts`
  - `apps/miniapp/lib/currentUser.ts`
  - `apps/miniapp/lib/auth.ts`
  - `apps/miniapp/lib/supabaseConfig.ts`
  - `apps/miniapp/components/AuthForm.tsx`
  - `apps/miniapp/app/(auth-related files)`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Реализован backend-поток авторизации: запрос кода по @username, сохранение кодов в таблице `auth_codes`, проверка кода, создание/чтение пользователя в таблице `users`, выдача JWT-сессии в HttpOnly-cookie.
  - Добавлен frontend-UI авторизации в Mini App (двухшаговая форма ввода username и кода), ограничивающий доступ к разделам платформы без входа.
  - Добавлена утилита определения текущего пользователя на серверной стороне для использования в layout и дальнейших разделах.

### Привязка Telegram chat_id и отправка кодов авторизации в бот (дата: 2025-12-08)
- Затронутые файлы и папки:
  - `docs/db/003_add_telegram_chat_id.sql`
  - `apps/miniapp/app/api/telegram/webhook/route.ts`
  - `apps/miniapp/app/api/auth/request-code/route.ts`
  - `apps/miniapp/components/AuthForm.tsx`
  - `README.md`
- Краткое описание:
  - Добавлено поле `telegram_chat_id` в таблицу `users` и индекс для быстрого поиска по chat_id.
  - Реализован webhook `/api/telegram/webhook`, сохраняющий `chat_id` из сообщений боту и связывающий его с `telegram_username`.
  - Отправка одноразовых кодов теперь идёт в личный чат по `telegram_chat_id`; если чат не привязан или отправка невозможна, код показывается в UI (delivery: `mock`).
  - Обновлена документация и тексты в UI, подсказывающие пользователю написать боту /start перед получением кода.

### MVP раздела «Знакомства»: схема, API, базовый UI (дата: 2025-12-09)
- Затронутые файлы и папки:
  - `docs/db/004_dating_schema.sql`
  - `apps/miniapp/app/api/dating/*`
  - `apps/miniapp/app/dating/page.tsx`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Добавлены таблицы `dating_profiles`, `dating_swipes`, `dating_matches` и enum `dating_purpose` для целей знакомств; настроены индексы и триггер обновления `updated_at`.
  - Реализованы сервисные маршруты `/api/dating/profile`, `/api/dating/feed`, `/api/dating/swipe`, `/api/dating/matches` с использованием `currentUser` и сервисного клиента Supabase.
  - Раздел «Знакомства» в Mini App переведён в рабочий режим: онбординг и редактирование анкеты, лента свайпов с записью решений и алертом о мэтче, блок «Мои мэтчи» с переходом в Telegram, компактный каталог последних анкет.

### Финализация целей знакомств и UI анкеты (дата: 2025-12-09)
- Затронутые файлы и папки:
  - `docs/db/005_update_dating_purpose.sql`
  - `apps/miniapp/app/api/dating/*`
  - `apps/miniapp/app/dating/page.tsx`
  - `apps/miniapp/lib/datingPurposes.ts`
  - `apps/miniapp/app/globals.css`
  - `README.md`
- Краткое описание:
  - Расширен enum `dating_purpose` до финального набора (добавлен `friends`) с безопасной миграцией.
  - Добавлен единый список целей знакомств для фронтенда и строгой серверной валидации.
  - Обновлена форма анкеты: показ 10 целей с описаниями, обязательный выбор целей и обработка ошибки `PURPOSES_REQUIRED`.
  - Документация дополнена разделом про цели знакомств.

### Шаг 3 — MVP для Маркет / Жильё / Работа (дата: 2025-12-10)
- Затронутые файлы и папки:
  - `apps/miniapp/app/api/market/listings/route.ts`
  - `apps/miniapp/app/api/housing/listings/route.ts`
  - `apps/miniapp/app/api/jobs/listings/route.ts`
  - `apps/miniapp/app/market/page.tsx`
  - `apps/miniapp/app/housing/page.tsx`
  - `apps/miniapp/app/jobs/page.tsx`
  - `README.md`
- Краткое описание:
  - Реализованы CRUD API для объявлений Маркета, Жилья и Работы с фильтрами по статусу, городу и специальным параметрам; добавлен параметр `mine=true` для выборки своих записей и валидация статусов draft/active/archived.
  - В Mini App добавлены рабочие вкладки «Маркет», «Жильё» и «Работа»: лента активных объявлений с фильтрами, блок «Мои объявления» с кнопкой редактирования, простые формы создания/обновления объявлений.
  - Напоминание: перед использованием разделов необходимо применить SQL `docs/db/006_market_housing_jobs.sql` и `docs/db/009_listing_contact_purchases.sql` в Supabase, чтобы таблицы объявлений и учёт покупок контактов существовали.

### Шаг 3 — система жалоб и блокировок в знакомствах (дата: 2025-12-10)
- Затронутые файлы и папки:
  - `docs/db/010_dating_reports_moderation.sql`
  - `apps/miniapp/app/api/dating/_helpers/reports.ts`
  - `apps/miniapp/app/api/dating/report/route.ts`
  - `apps/miniapp/app/api/dating/feed/route.ts`
  - `apps/miniapp/app/api/dating/matches/route.ts`
  - `apps/miniapp/app/api/dating/swipe/route.ts`
  - `apps/miniapp/app/dating/page.tsx`
  - `README.md`
- Краткое описание:
  - Добавлена таблица `dating_reports` и API `/api/dating/report` для отправки жалоб с причинами и комментарием; проверка на повторные жалобы от одного пользователя.
  - Пометка `users.status = banned` выставляется автоматически после трёх жалоб, такие пользователи исключаются из ленты знакомств и новых свайпов/мэтчей.
  - В Mini App появилась кнопка «Пожаловаться» на анкеты, модальное окно выбора причины и пометка заблокированных профилей в разделе мэтчей.

### Шаг 4 — MVP покупки контактов по объявлениям (дата: 2025-12-11)
- Затронутые файлы и папки:
  - `docs/db/009_listing_contact_purchases.sql`
  - `apps/miniapp/app/api/listings/_helpers/contacts.ts`
  - `apps/miniapp/app/api/listings/contact/route.ts`
  - `apps/miniapp/app/_hooks/useListingContact.ts`
  - `apps/miniapp/app/_components/ListingContactActions.tsx`
  - `apps/miniapp/app/market/page.tsx`
  - `apps/miniapp/app/housing/page.tsx`
  - `apps/miniapp/app/jobs/page.tsx`
  - `README.md`
- Краткое описание:
  - Добавлена таблица `listing_contact_purchases` для учёта покупок контактов по объявлениям Маркета, Жилья и Работы (фиксированная стоимость 50 ₽), миграцию необходимо применять в Supabase.
  - Реализован API `/api/listings/contact`: проверяет авторизацию, валидирует раздел/ID объявления, получает владельца и Telegram-username, не позволяет покупать собственное объявление, создаёт запись покупки или возвращает существующую.
  - В карточках объявлений добавлена кнопка «Познакомиться по объявлению»: после подтверждения вызывается API, отображается контакт владельца и ссылка на Telegram, состояние покупки сохраняется в UI на время сессии.

### Шаг 5 — Панель модерации знакомств (дата: 2025-12-10)
- Затронутые файлы и папки:
  - `apps/miniapp/app/moderation/dating/*`
  - `apps/miniapp/app/api/moderation/dating/*`
  - `apps/miniapp/lib/moderators.ts`
  - `apps/miniapp/app/api/dating/_helpers/reports.ts`
  - `docs/db/010_dating_reports_moderation.sql`
  - `README.md`, `env.local`
- Краткое описание архитектуры и потока:
  - Добавлена переменная окружения `MODERATOR_USERNAMES`, определяющая список Telegram-username модераторов; серверные проверки используют helper `isModeratorUser`.
  - Новый маршрут `/moderation/dating` в Mini App (Next.js App Router) доступен только модераторам и отображает статистику знакомств, фильтруемый список жалоб, а также действия «обработать», «забанить», «снять бан» для каждого пользователя.
  - API `/api/moderation/dating` проверяет роль модератора, поддерживает `GET` для выборки жалоб (джойны на пользователей, подсчёт количества жалоб, флаг бана, агрегированная статистика) и `POST` для `resolveReport|banUser|unbanUser` с логированием `resolved_at`, `resolved_by_user_id`, `moderator_note` и обновлением `users.status`.
  - Схема `dating_reports` расширена полями `status`, `resolved_at`, `resolved_by_user_id`, `moderator_note`, статус по умолчанию `new` с миграцией старого `pending`; новая жалоба также записывается со статусом `new`. Расширение выполняется отдельной миграцией `docs/db/010_dating_reports_moderation.sql`, а исходное создание таблицы остаётся в `docs/db/008_dating_reports.sql`. Автобан по 3 жалобам сохранён, ручной бан/анбан меняет `users.status` и учитывается в ленте знакомств.

### Шаг 6 — Модерация объявлений (дата: 2025-12-11)
- Затронутые файлы и папки:
  - `docs/db/011_listing_reports.sql`
  - `apps/miniapp/app/api/listings/report/route.ts`
  - `apps/miniapp/app/api/moderation/listings/route.ts`
  - `apps/miniapp/app/moderation/listings/*`
  - `apps/miniapp/app/_components/ListingReportButton.tsx`
  - страницы разделов `apps/miniapp/app/market/page.tsx`, `.../housing/page.tsx`, `.../jobs/page.tsx`
  - `README.md`
- Краткое описание архитектуры и потока:
  - Добавлена таблица `listing_reports` с жалобами на объявления (секции Маркет/Жильё/Работа, автор, владелец, причина, комментарий, статусы, отметки модерации) и индексами/ограничением на повторную жалобу одного пользователя.
  - Пользователь отправляет жалобу из карточки объявления через `/api/listings/report`; после трёх новых жалоб объявление автоматически архивируется (`status = archived`). UI разделов добавляет кнопку «Пожаловаться» с модальным окном причин и toast-уведомлением.
  - Панель модератора `/moderation/listings` показывает жалобы с данными объявлений, владельцев и счётчиком, фильтруется по статусу и секции, позволяет помечать жалобу обработанной, скрывать/возвращать объявление и банить/разбанивать владельца. API `/api/moderation/listings` отдаёт список и статистику (новые жалобы по секциям, активные/архивные объявления с жалобами) и выполняет действия `resolveReport|archiveListing|unarchiveListing|banUser|unbanUser`.

